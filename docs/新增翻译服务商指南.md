# æ–°å¢ç¿»è¯‘æœåŠ¡å•†æŒ‡å—

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜å¦‚ä½•åœ¨æ–‡æ¡£ç¿»è¯‘ç³»ç»Ÿä¸­æ·»åŠ æ–°çš„ç¿»è¯‘æœåŠ¡å•†ï¼ˆProviderï¼‰ã€‚

## ğŸ“‹ ç›®å½•

- [ç³»ç»Ÿæ¶æ„æ¦‚è¿°](#ç³»ç»Ÿæ¶æ„æ¦‚è¿°)
- [å¿«é€Ÿå¼€å§‹ï¼ˆå…¼å®¹ OpenAI APIï¼‰](#å¿«é€Ÿå¼€å§‹å…¼å®¹-openai-api)
- [å®Œæ•´å®ç°ï¼ˆè‡ªå®šä¹‰ APIï¼‰](#å®Œæ•´å®ç°è‡ªå®šä¹‰-api)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
- [å‰ç«¯é›†æˆ](#å‰ç«¯é›†æˆ)
- [æµ‹è¯•éªŒè¯](#æµ‹è¯•éªŒè¯)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ç³»ç»Ÿæ¶æ„æ¦‚è¿°

### Provider å±‚çº§ç»“æ„

```
BaseProvider (æŠ½è±¡åŸºç±»)
    â”œâ”€â”€ CloudProviderValidationMixin (äº‘ç«¯ Provider éªŒè¯æ··å…¥)
    â”œâ”€â”€ LocalProviderValidationMixin (æœ¬åœ° Provider éªŒè¯æ··å…¥)
    â”œâ”€â”€ OpenAIProvider (OpenAI API å®ç°)
    â”‚   â”œâ”€â”€ MimoProvider (Mimo API - ç»§æ‰¿ OpenAI)
    â”‚   â”œâ”€â”€ DeepSeekProvider (DeepSeek API - ç»§æ‰¿ OpenAI)
    â”‚   â””â”€â”€ YourProvider (ä½ çš„æœåŠ¡å•† - å¯ç»§æ‰¿ OpenAI)
    â”œâ”€â”€ OllamaProvider (Ollama æœ¬åœ°æœåŠ¡)
    â””â”€â”€ MockProvider (æµ‹è¯•ç”¨)
```

### æ ¸å¿ƒç»„ä»¶

1. **BaseProvider** - å®šä¹‰ç»Ÿä¸€çš„ Provider æ¥å£
2. **ProviderRegistry** - Provider æ³¨å†Œä¸­å¿ƒï¼Œç®¡ç†æ‰€æœ‰ Provider çš„åˆ›å»ºå’Œè·å–
3. **ProviderConfig** - Provider é…ç½®æ•°æ®ç±»
4. **ProviderType** - Provider ç±»å‹æšä¸¾

---

## å¿«é€Ÿå¼€å§‹ï¼ˆå…¼å®¹ OpenAI APIï¼‰

å¦‚æœæ–°æœåŠ¡å•†å…¼å®¹ OpenAI APIï¼ˆå¤§å¤šæ•°ç°ä»£ AI æœåŠ¡å•†éƒ½æ˜¯ï¼‰ï¼Œåªéœ€ä»¥ä¸‹ 3 ä¸ªç®€å•æ­¥éª¤ï¼š

### æ­¥éª¤ 1: æ·»åŠ  Provider ç±»å‹

åœ¨ `src/core/types.py` çš„ `ProviderType` æšä¸¾ä¸­æ·»åŠ æ–°ç±»å‹ï¼š

```python
class ProviderType(Enum):
    """Provider ç±»å‹æšä¸¾"""
    OPENAI = "openai"
    OLLAMA = "ollama"
    MOCK = "mock"
    MIMO = "mimo"
    DEEPSEEK = "deepseek"
    QWEN = "qwen"  # âœ… æ–°å¢ï¼šé˜¿é‡Œäº‘é€šä¹‰åƒé—®
```

### æ­¥éª¤ 2: åˆ›å»º Provider ç±»

åˆ›å»º `src/providers/qwen/provider.py`ï¼š

```python
"""
Qwen Provider Implementation

é˜¿é‡Œäº‘é€šä¹‰åƒé—® API Provider å®ç°ï¼Œå…¼å®¹ OpenAI APIã€‚
"""

import logging
from typing import Dict, Any, Optional, List

from providers.base import BaseProvider, ProviderConfig, ModelInfo, ModelCapability
from providers.openai.provider import OpenAIProvider
from core.types import ProviderType

logger = logging.getLogger(__name__)


class QwenProvider(OpenAIProvider):
    """
    é˜¿é‡Œäº‘é€šä¹‰åƒé—® Provider å®ç°

    ç”±äºé€šä¹‰åƒé—® API å…¼å®¹ OpenAI APIï¼Œæˆ‘ä»¬ç›´æ¥ç»§æ‰¿ OpenAIProviderï¼Œ
    åªéœ€é‡å†™å¿…è¦çš„æ–¹æ³•å³å¯ã€‚
    """

    def __init__(self, provider_config: ProviderConfig, models_config: Optional[List[str]] = None):
        """
        åˆå§‹åŒ– Qwen Provider

        Args:
            provider_config: Provider é…ç½®ï¼ˆåŒ…å« API Keyã€Base URL ç­‰ï¼‰
            models_config: ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–çš„å…è®¸ä½¿ç”¨çš„æ¨¡å‹åˆ—è¡¨
        """
        # è°ƒç”¨çˆ¶ç±» OpenAIProvider çš„åˆå§‹åŒ–
        super().__init__(provider_config, models_config)
        logger.info(f"Qwen Provider initialized with models: {models_config}")

    def get_name(self) -> str:
        """è·å– Provider åç§°"""
        return "qwen"

    def get_provider_info(self) -> Dict[str, Any]:
        """è·å– Provider ä¿¡æ¯"""
        info = super().get_provider_info()
        info["provider_type"] = ProviderType.QWEN.value
        info["provider_name"] = "é˜¿é‡Œäº‘é€šä¹‰åƒé—®"
        info["provider_description"] = "é˜¿é‡Œäº‘å¤§è¯­è¨€æ¨¡å‹æœåŠ¡"
        return info

    def __repr__(self) -> str:
        return f"<QwenProvider(base_url={self.base_url}, configured={self.is_configured()})>"
```

åˆ›å»º `src/providers/qwen/__init__.py`ï¼š

```python
"""
Qwen Provider Package
"""

from .provider import QwenProvider

__all__ = ['QwenProvider']
```

### æ­¥éª¤ 3: æ³¨å†Œ Provider

åœ¨ `src/providers/registry.py` ä¸­æ³¨å†Œæ–°çš„ Providerï¼š

#### 3.1 åœ¨ `_register_default_classes` æ–¹æ³•ä¸­æ·»åŠ ï¼š

```python
def _register_default_classes(self) -> None:
    """æ³¨å†Œé»˜è®¤çš„ Provider ç±»"""
    # å»¶è¿Ÿå¯¼å…¥é¿å…å¾ªç¯ä¾èµ–
    try:
        from .openai.provider import OpenAIProvider
        self.register_provider_class(ProviderType.OPENAI, OpenAIProvider)
    except ImportError:
        logger.warning("OpenAI provider not available")

    # ... å…¶ä»– Provider æ³¨å†Œ ...

    # âœ… æ–°å¢ï¼šæ³¨å†Œ Qwen Provider
    try:
        from .qwen.provider import QwenProvider
        self.register_provider_class(ProviderType.QWEN, QwenProvider)
    except ImportError:
        logger.warning("Qwen provider not available")
```

#### 3.2 åœ¨ `_get_provider_type` æ–¹æ³•ä¸­æ·»åŠ æ˜ å°„ï¼š

```python
def _get_provider_type(self, provider_name: str) -> Optional[ProviderType]:
    """
    æ ¹æ®åç§°è·å– Provider ç±»å‹

    Args:
        provider_name: Provider åç§°

    Returns:
        Provider ç±»å‹æˆ– None
    """
    provider_mapping = {
        "openai": ProviderType.OPENAI,
        "ollama": ProviderType.OLLAMA,
        "mimo": ProviderType.MIMO,
        "deepseek": ProviderType.DEEPSEEK,
        "mock": ProviderType.MOCK,
        "qwen": ProviderType.QWEN,  # âœ… æ–°å¢
    }

    return provider_mapping.get(provider_name.lower())
```

#### 3.3 åœ¨ `get_or_create` æ–¹æ³•ä¸­æ·»åŠ æ¨¡å‹é…ç½®ï¼š

```python
def get_or_create(self, provider_name: str, model: Optional[str] = None, config: Optional[ProviderConfig] = None) -> Optional[BaseProvider]:
    """è·å–æˆ–åˆ›å»º Provider å®ä¾‹"""
    # ... å‰é¢çš„ä»£ç  ...

    if provider_type == ProviderType.OPENAI:
        models_config = global_config.openai_models
        provider = self._provider_classes[provider_type](config, models_config)
    elif provider_type == ProviderType.MIMO:
        models_config = global_config.mimo_models
        provider = self._provider_classes[provider_type](config, models_config)
    elif provider_type == ProviderType.DEEPSEEK:
        models_config = global_config.deepseek_models
        provider = self._provider_classes[provider_type](config, models_config)
    elif provider_type == ProviderType.QWEN:  # âœ… æ–°å¢
        models_config = global_config.qwen_models
        provider = self._provider_classes[provider_type](config, models_config)
    else:
        provider = self._provider_classes[provider_type](config)

    # ... åé¢çš„ä»£ç  ...
```

### æ­¥éª¤ 4: æ·»åŠ ç¯å¢ƒé…ç½®

åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ `.env` æ–‡ä»¶ä¸­æ·»åŠ é…ç½®ï¼š

```bash
# ==================================================
# Qwen (é˜¿é‡Œäº‘é€šä¹‰åƒé—®) Configuration
# ==================================================

# Provider åç§°
LLM_PROVIDER=qwen

# API å¯†é’¥ï¼ˆä»é˜¿é‡Œäº‘æ§åˆ¶å°è·å–ï¼‰
QWEN_API_KEY=sk-your-qwen-api-key-here

# å¯ç”¨æ¨¡å‹åˆ—è¡¨
QWEN_MODELS=["qwen-turbo", "qwen-plus", "qwen-max", "qwen-max-longcontext"]

# API Base URLï¼ˆé€šä¹‰åƒé—®å…¼å®¹æ¨¡å¼ï¼‰
QWEN_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
```

**æç¤º**ï¼šè·å– Qwen API Key çš„æ­¥éª¤ï¼š
1. è®¿é—® [é˜¿é‡Œäº‘ç™¾ç‚¼å¹³å°](https://bailian.console.aliyun.com/)
2. åˆ›å»º API-KEY
3. å¤åˆ¶ API Key åˆ° `.env` æ–‡ä»¶

### æ­¥éª¤ 5: æ›´æ–°é…ç½®åŠ è½½é€»è¾‘

åœ¨ `src/core/config.py` ä¸­æ·»åŠ é…ç½®è¯»å–ï¼š

```python
class Config:
    """å…¨å±€é…ç½®ç®¡ç†"""

    # ... ç°æœ‰å±æ€§ ...

    @property
    def qwen_api_key(self) -> str:
        """è·å– Qwen API Key"""
        return os.getenv("QWEN_API_KEY", "")

    @property
    def qwen_base_url(self) -> str:
        """è·å– Qwen Base URL"""
        return os.getenv("QWEN_BASE_URL", "https://dashscope.aliyuncs.com/compatible-mode/v1")

    @property
    def qwen_models(self) -> List[str]:
        """è·å– Qwen çš„æ¨¡å‹åˆ—è¡¨"""
        models_str = os.getenv("QWEN_MODELS", '["qwen-turbo", "qwen-plus", "qwen-max"]')
        try:
            return json.loads(models_str)
        except json.JSONDecodeError:
            logger.warning(f"Failed to parse QWEN_MODELS: {models_str}")
            return ["qwen-turbo"]

    def get_provider_config(self, provider_name: str) -> Dict[str, Any]:
        """
        è·å– Provider é…ç½®

        Args:
            provider_name: Provider åç§°

        Returns:
            Provider é…ç½®å­—å…¸
        """
        provider_name = provider_name.lower()

        # ... å…¶ä»– Provider çš„é…ç½® ...

        if provider_name == "qwen":
            return {
                "provider_type": ProviderType.QWEN,
                "api_key": self.qwen_api_key,
                "base_url": self.qwen_base_url,
                "timeout_seconds": 120,
                "max_retries": 3,
            }

        # ... é»˜è®¤é…ç½® ...
```

---

## å®Œæ•´å®ç°ï¼ˆè‡ªå®šä¹‰ APIï¼‰

å¦‚æœæœåŠ¡å•†ä¸å…¼å®¹ OpenAI APIï¼Œéœ€è¦å®Œæ•´å®ç° `BaseProvider` çš„æ‰€æœ‰æŠ½è±¡æ–¹æ³•ã€‚

### ç¤ºä¾‹ï¼šå®ç°è‡ªå®šä¹‰ API Provider

```python
"""
Custom Provider Implementation

å®Œå…¨è‡ªå®šä¹‰ API çš„ Provider å®ç°ç¤ºä¾‹ã€‚
"""

import logging
import requests
from typing import Dict, Any, Optional, List, Tuple

from providers.base import (
    BaseProvider,
    ProviderConfig,
    ModelInfo,
    ModelCapability
)
from providers.mixins import CloudProviderValidationMixin
from core.types import ProviderType

logger = logging.getLogger(__name__)


class CustomProvider(BaseProvider, CloudProviderValidationMixin):
    """
    è‡ªå®šä¹‰ API Provider å®ç°

    å®ç°æ‰€æœ‰å¿…éœ€çš„ BaseProvider æ–¹æ³•ã€‚
    """

    def __init__(self, provider_config: ProviderConfig):
        """
        åˆå§‹åŒ– Custom Provider

        Args:
            provider_config: Provider é…ç½®
        """
        super().__init__(provider_config)
        self.api_key = provider_config.api_key
        self.base_url = provider_config.base_url
        self.session = requests.Session()
        self.session.headers.update({
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json"
        })

    # ==================================================
    # é…ç½®éªŒè¯ç›¸å…³æ–¹æ³•
    # ==================================================

    def is_configured(self) -> bool:
        """
        æ£€æŸ¥ Provider æ˜¯å¦å·²é…ç½®

        Returns:
            æ˜¯å¦å·²é…ç½®
        """
        return bool(self.api_key)

    def validate_configuration(self) -> Tuple[bool, Optional[str]]:
        """
        éªŒè¯ Provider é…ç½®

        Cloud Provider ä¸“ç”¨: æ£€æŸ¥ API Key æœ‰æ•ˆæ€§

        Returns:
            (is_valid, error_message): é…ç½®æ˜¯å¦æœ‰æ•ˆåŠé”™è¯¯ä¿¡æ¯
        """
        # ä½¿ç”¨ Cloud Provider é€šç”¨æ ¡éªŒé€»è¾‘
        return self.validate_api_key(self.config.api_key)

    def health_check(self) -> Tuple[bool, Optional[str]]:
        """
        çœŸå® Health Check

        Cloud Provider ä¸“ç”¨: éªŒè¯ API Key + å°è¯•åˆå§‹åŒ–

        Returns:
            (is_healthy, error_message): æ˜¯å¦å¥åº·åŠé”™è¯¯ä¿¡æ¯
        """
        # ç¬¬ä¸€æ­¥: é…ç½®éªŒè¯
        is_valid, error_msg = self.validate_configuration()
        if not is_valid:
            return False, error_msg

        # ç¬¬äºŒæ­¥: å°è¯•è°ƒç”¨ API
        try:
            response = self.session.get(
                f"{self.base_url}/models",
                timeout=10
            )
            if response.status_code == 200:
                return True, None
            else:
                return False, f"API returned status {response.status_code}"
        except Exception as e:
            return False, f"Health check failed: {str(e)}"

    # ==================================================
    # æ¨¡å‹ç®¡ç†ç›¸å…³æ–¹æ³•
    # ==================================================

    def get_available_models(self) -> List[str]:
        """
        è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨

        Returns:
            æ¨¡å‹åç§°åˆ—è¡¨
        """
        if not self.is_configured():
            return []

        try:
            response = self.session.get(
                f"{self.base_url}/models",
                timeout=10
            )
            if response.status_code == 200:
                data = response.json()
                # å‡è®¾ API è¿”å›æ ¼å¼ä¸º {"models": [{"id": "model-1"}, ...]}
                return [model["id"] for model in data.get("models", [])]
        except Exception as e:
            logger.error(f"Failed to get models: {e}")

        return []

    def get_model_info(self, model_name: str) -> Optional[ModelInfo]:
        """
        è·å–æ¨¡å‹ä¿¡æ¯

        Args:
            model_name: æ¨¡å‹åç§°

        Returns:
            æ¨¡å‹ä¿¡æ¯æˆ– None
        """
        if model_name not in self.get_available_models():
            return None

        return ModelInfo(
            name=model_name,
            provider=ProviderType.CUSTOM,
            capabilities=[
                ModelCapability.TEXT_GENERATION,
                ModelCapability.TRANSLATION,
                ModelCapability.MULTILINGUAL
            ],
            max_tokens=4096,
            supports_streaming=True,
            supports_function_calling=False
        )

    # ==================================================
    # æ–‡æœ¬ç”Ÿæˆç›¸å…³æ–¹æ³•
    # ==================================================

    async def generate_async(
        self,
        prompt: str,
        model: str,
        temperature: float = 0.7,
        max_tokens: Optional[int] = None,
        **kwargs
    ) -> str:
        """
        å¼‚æ­¥ç”Ÿæˆæ–‡æœ¬

        Args:
            prompt: è¾“å…¥æç¤º
            model: æ¨¡å‹åç§°
            temperature: æ¸©åº¦å‚æ•°
            max_tokens: æœ€å¤§ç”Ÿæˆ token æ•°
            **kwargs: å…¶ä»–å‚æ•°

        Returns:
            ç”Ÿæˆçš„æ–‡æœ¬
        """
        if not self.is_configured():
            raise RuntimeError("Custom provider is not configured")

        try:
            # ä½¿ç”¨ run_in_executor åœ¨çº¿ç¨‹æ± ä¸­è¿è¡ŒåŒæ­¥è¯·æ±‚
            import asyncio
            loop = asyncio.get_event_loop()
            return await loop.run_in_executor(
                None,
                self._sync_generate,
                prompt,
                model,
                temperature,
                max_tokens,
                **kwargs
            )
        except Exception as e:
            logger.error(f"Error generating text with Custom provider: {e}")
            raise

    def _sync_generate(
        self,
        prompt: str,
        model: str,
        temperature: float,
        max_tokens: Optional[int],
        **kwargs
    ) -> str:
        """
        åŒæ­¥ç”Ÿæˆæ–‡æœ¬ï¼ˆå†…éƒ¨æ–¹æ³•ï¼‰

        Args:
            prompt: è¾“å…¥æç¤º
            model: æ¨¡å‹åç§°
            temperature: æ¸©åº¦å‚æ•°
            max_tokens: æœ€å¤§ç”Ÿæˆ token æ•°
            **kwargs: å…¶ä»–å‚æ•°

        Returns:
            ç”Ÿæˆçš„æ–‡æœ¬
        """
        payload = {
            "model": model,
            "messages": [{"role": "user", "content": prompt}],
            "temperature": temperature,
        }

        if max_tokens:
            payload["max_tokens"] = max_tokens

        response = self.session.post(
            f"{self.base_url}/chat/completions",
            json=payload,
            timeout=self.config.timeout_seconds
        )

        response.raise_for_status()
        data = response.json()

        # å‡è®¾ API è¿”å›æ ¼å¼ä¸ OpenAI å…¼å®¹
        return data["choices"][0]["message"]["content"]

    # ==================================================
    # ç¿»è¯‘ç›¸å…³æ–¹æ³•
    # ==================================================

    def translate(
        self,
        text: str,
        source_lang: str = "zh",
        target_lang: str = "en",
        model: Optional[str] = None,
        **kwargs
    ) -> str:
        """
        ç¿»è¯‘æ–‡æœ¬

        Args:
            text: å¾…ç¿»è¯‘æ–‡æœ¬
            source_lang: æºè¯­è¨€
            target_lang: ç›®æ ‡è¯­è¨€
            model: æ¨¡å‹åç§°ï¼ˆå¯é€‰ï¼‰
            **kwargs: å…¶ä»–å‚æ•°

        Returns:
            ç¿»è¯‘åçš„æ–‡æœ¬
        """
        if not text.strip():
            return text

        if not model:
            # ä½¿ç”¨é»˜è®¤æ¨¡å‹
            available_models = self.get_available_models()
            if not available_models:
                raise RuntimeError("No models available")
            model = available_models[0]

        # æ„å»ºç¿»è¯‘æç¤º
        prompt = f"""è¯·å°†ä»¥ä¸‹{source_lang}æ–‡æœ¬ç¿»è¯‘ä¸º{target_lang}ï¼š

{text}

è¦æ±‚ï¼š
1. ä¿æŒåŸæ–‡çš„æ„æ€å’Œè¯­æ°”
2. ä½¿ç”¨è‡ªç„¶æµç•…çš„{target_lang}è¡¨è¾¾
3. åªè¿”å›ç¿»è¯‘ç»“æœï¼Œä¸è¦æ·»åŠ è§£é‡Š"""

        try:
            return self.generate(prompt, model, temperature=0.3, **kwargs)
        except Exception as e:
            logger.error(f"Translation failed: {e}")
            # è¿”å›åŸæ–‡æœ¬ä½œä¸ºåå¤‡
            return text

    # ==================================================
    # å·¥å…·æ–¹æ³•
    # ==================================================

    def get_name(self) -> str:
        """è·å– Provider åç§°"""
        return "custom"

    def get_provider_info(self) -> Dict[str, Any]:
        """è·å– Provider ä¿¡æ¯"""
        return {
            "provider_type": ProviderType.CUSTOM.value,
            "provider_name": "Custom Provider",
            "provider_description": "è‡ªå®šä¹‰ API Provider",
            "is_configured": self.is_configured(),
            "available_models": self.get_available_models(),
            "config": {
                "timeout_seconds": self.config.timeout_seconds,
                "max_retries": self.config.max_retries,
                "has_api_key": bool(self.config.api_key),
                "base_url": self.config.base_url
            }
        }

    def __repr__(self) -> str:
        return f"<CustomProvider(base_url={self.base_url}, configured={self.is_configured()})>"
```

---

## é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡å‘½åè§„èŒƒ

æ‰€æœ‰æœåŠ¡å•†é…ç½®éµå¾ªä»¥ä¸‹å‘½åè§„èŒƒï¼š

```bash
# Provider é…ç½®æ¨¡æ¿
{PROVIDER_NAME}_API_KEY=your_api_key_here
{PROVIDER_NAME}_MODELS=["model-1", "model-2", "model-3"]
{PROVIDER_NAME}_BASE_URL=https://api.provider.com/v1
```

### æ”¯æŒçš„é…ç½®é€‰é¡¹

| é…ç½®é¡¹ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|--------|------|------|------|
| `api_key` | string | æ˜¯* | API å¯†é’¥ï¼ˆæœ¬åœ° Provider ä¸éœ€è¦ï¼‰ |
| `base_url` | string | æ˜¯ | API åŸºç¡€ URL |
| `models` | list | æ˜¯ | æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨ |
| `timeout_seconds` | int | å¦ | è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤ 120ï¼‰ |
| `max_retries` | int | å¦ | æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆé»˜è®¤ 3ï¼‰ |

### å¸¸è§æœåŠ¡å•†é…ç½®ç¤ºä¾‹

#### OpenAI

```bash
OPENAI_API_KEY=sk-your-openai-api-key
OPENAI_MODELS=["gpt-3.5-turbo", "gpt-4", "gpt-4-turbo", "gpt-4o"]
OPENAI_BASE_URL=https://api.openai.com/v1
```

#### é˜¿é‡Œäº‘é€šä¹‰åƒé—® (Qwen)

```bash
QWEN_API_KEY=sk-your-qwen-api-key
QWEN_MODELS=["qwen-turbo", "qwen-plus", "qwen-max", "qwen-max-longcontext"]
QWEN_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
```

#### Moonshot (æœˆä¹‹æš—é¢)

```bash
MOONSHOT_API_KEY=sk-your-moonshot-api-key
MOONSHOT_MODELS=["moonshot-v1-8k", "moonshot-v1-32k", "moonshot-v1-128k"]
MOONSHOT_BASE_URL=https://api.moonshot.cn/v1
```

#### æ™ºè°± AI (ChatGLM)

```bash
CHATGLM_API_KEY=your-chatglm-api-key
CHATGLM_MODELS=["glm-4", "glm-4-flash", "glm-4-air", "glm-3-turbo"]
CHATGLM_BASE_URL=https://open.bigmodel.cn/api/paas/v4
```

---

## å‰ç«¯é›†æˆ

### æ›´æ–° TypeScript ç±»å‹å®šä¹‰

åœ¨ `frontend/src/types/api.ts` ä¸­æ›´æ–° provider ç±»å‹ï¼š

```typescript
/**
 * Provider åç§°ç±»å‹
 */
export type ProviderName =
  | "openai"
  | "ollama"
  | "mimo"
  | "deepseek"
  | "mock"
  | "qwen";  // âœ… æ–°å¢

/**
 * ç¿»è¯‘è¯·æ±‚æ¥å£
 */
export interface TranslationRequest {
  source_markdown: string;
  glossary?: Record<string, string>;
  llm_config?: {
    provider: ProviderName;  // ä¼šè‡ªåŠ¨åŒ…å«æ–°ç±»å‹
    model: string;
    temperature?: number;
    extra_options?: Record<string, any>;
  };
}
```

### æ›´æ–° Provider é€‰æ‹©å™¨

åœ¨ `frontend/src/components/ProviderSelector/index.tsx` ä¸­æ·»åŠ æ–°æœåŠ¡å•†ä¿¡æ¯ï¼š

```typescript
const providerInfo: Record<string, { name: string; description: string; color: string }> = {
  openai: {
    name: 'OpenAIå…¼å®¹',
    description: 'å…¼å®¹OpenAI APIçš„LLMæ¨¡å‹ï¼Œé€‚åˆä¸“ä¸šç¿»è¯‘',
    color: '#10a37f'
  },
  ollama: {
    name: 'Ollama',
    description: 'æœ¬åœ°è¿è¡Œçš„å¼€æºæ¨¡å‹ï¼Œä¿æŠ¤éšç§',
    color: '#ff6b35'
  },
  mimo: {
    name: 'Mimo',
    description: 'å°ç±³Mimo AIæ¨¡å‹ï¼Œé«˜æ•ˆå¿«é€Ÿ',
    color: '#FF6900'
  },
  deepseek: {
    name: 'DeepSeek',
    description: 'DeepSeekæ¨ç†æ¨¡å‹ï¼Œæ“…é•¿å¤æ‚é€»è¾‘',
    color: '#4D6BFE'
  },
  qwen: {  // âœ… æ–°å¢
    name: 'é€šä¹‰åƒé—®',
    description: 'é˜¿é‡Œäº‘å¤§è¯­è¨€æ¨¡å‹æœåŠ¡ï¼Œæ”¯æŒå¤šç§åœºæ™¯',
    color: '#FF6A00'
  }
};
```

---

## æµ‹è¯•éªŒè¯

### 1. å•å…ƒæµ‹è¯•

åˆ›å»º `tests/providers/test_qwen_provider.py`ï¼š

```python
"""
Qwen Provider å•å…ƒæµ‹è¯•
"""

import pytest
from providers.qwen.provider import QwenProvider
from providers.base import ProviderConfig
from core.types import ProviderType


def test_qwen_provider_initialization():
    """æµ‹è¯• Qwen Provider åˆå§‹åŒ–"""
    config = ProviderConfig(
        provider_type=ProviderType.QWEN,
        api_key="test-key",
        base_url="https://dashscope.aliyuncs.com/compatible-mode/v1"
    )

    provider = QwenProvider(config, ["qwen-turbo", "qwen-plus"])

    assert provider.get_name() == "qwen"
    assert provider.is_configured()


def test_qwen_provider_models():
    """æµ‹è¯•è·å–å¯ç”¨æ¨¡å‹"""
    config = ProviderConfig(
        provider_type=ProviderType.QWEN,
        api_key="test-key",
        base_url="https://dashscope.aliyuncs.com/compatible-mode/v1"
    )

    provider = QwenProvider(config, ["qwen-turbo", "qwen-plus", "qwen-max"])

    models = provider.get_available_models()
    assert "qwen-turbo" in models
    assert "qwen-plus" in models
    assert "qwen-max" in models
    assert len(models) == 3
```

è¿è¡Œæµ‹è¯•ï¼š

```bash
pytest tests/providers/test_qwen_provider.py -v
```

### 2. é›†æˆæµ‹è¯•

#### æ£€æŸ¥ Provider çŠ¶æ€

```bash
curl http://localhost:8000/api/v1/providers/qwen/status
```

é¢„æœŸå“åº”ï¼š

```json
{
  "success": true,
  "provider": "qwen",
  "available": true,
  "models": ["qwen-turbo", "qwen-plus", "qwen-max"]
}
```

#### æµ‹è¯•ç¿»è¯‘åŠŸèƒ½

```bash
curl -X POST "http://localhost:8000/api/v1/translate" \
  -H "Content-Type: application/json" \
  -d '{
    "source_markdown": "# æµ‹è¯•æ ‡é¢˜\nè¿™æ˜¯æµ‹è¯•å†…å®¹",
    "llm_config": {
      "provider": "qwen",
      "model": "qwen-turbo",
      "temperature": 0.3
    }
  }'
```

### 3. å‰ç«¯æµ‹è¯•

1. å¯åŠ¨å‰ç«¯æœåŠ¡ï¼š
```bash
cd frontend
npm run dev
```

2. æ‰“å¼€æµè§ˆå™¨è®¿é—® `http://localhost:5173`

3. åœ¨ Provider é€‰æ‹©å™¨ä¸­éªŒè¯ï¼š
   - èƒ½å¦çœ‹åˆ°æ–°æ·»åŠ çš„ Provider
   - èƒ½å¦é€‰æ‹©è¯¥ Provider çš„æ¨¡å‹
   - èƒ½å¦æ­£å¸¸ä¸Šä¼ æ–‡ä»¶å¹¶ç¿»è¯‘

---

## å¸¸è§é—®é¢˜

### Q1: Provider æ˜¾ç¤º"ä¸å¯ç”¨"

**å¯èƒ½åŸå› **ï¼š
1. API Key æœªé…ç½®æˆ–é…ç½®é”™è¯¯
2. Base URL é…ç½®é”™è¯¯
3. ç½‘ç»œè¿æ¥é—®é¢˜

**è§£å†³æ–¹æ³•**ï¼š
```bash
# æ£€æŸ¥ç¯å¢ƒå˜é‡
echo $QWEN_API_KEY
echo $QWEN_BASE_URL

# æ£€æŸ¥ API è¿é€šæ€§
curl -H "Authorization: Bearer $QWEN_API_KEY" \
  https://dashscope.aliyuncs.com/compatible-mode/v1/models
```

### Q2: ç¿»è¯‘å¤±è´¥ï¼Œæç¤º"Provider not found"

**å¯èƒ½åŸå› **ï¼š
1. Provider æœªåœ¨ `registry.py` ä¸­æ³¨å†Œ
2. Provider ç±»å‹æšä¸¾æœªæ·»åŠ 
3. Provider ç±»å¯¼å…¥å¤±è´¥

**è§£å†³æ–¹æ³•**ï¼š
```python
# æ£€æŸ¥ registry.py
from providers.qwen.provider import QwenProvider  # æ˜¯å¦èƒ½æ­£å¸¸å¯¼å…¥

# æ£€æŸ¥ ProviderType
ProviderType.QWEN.value  # åº”è¯¥è¿”å› "qwen"

# æ£€æŸ¥æ˜ å°„
provider_mapping.get("qwen")  # åº”è¯¥è¿”å› ProviderType.QWEN
```

### Q3: æ¨¡å‹åˆ—è¡¨ä¸ºç©º

**å¯èƒ½åŸå› **ï¼š
1. `MODELS` ç¯å¢ƒå˜é‡æœªé…ç½®æˆ–æ ¼å¼é”™è¯¯
2. é…ç½®åŠ è½½é€»è¾‘æœ‰é—®é¢˜

**è§£å†³æ–¹æ³•**ï¼š
```bash
# æ£€æŸ¥ç¯å¢ƒå˜é‡ï¼ˆæ³¨æ„ JSON æ ¼å¼ï¼‰
echo $QWEN_MODELS
# æ­£ç¡®æ ¼å¼ï¼š["qwen-turbo", "qwen-plus"]
# é”™è¯¯æ ¼å¼ï¼šqwen-turbo,qwen-plusï¼ˆç¼ºå°‘ JSON æ ¼å¼ï¼‰

# æµ‹è¯•è§£æ
python3 -c "import json, os; print(json.loads(os.getenv('QWEN_MODELS')))"
```

### Q4: ç¿»è¯‘ç»“æœåŒ…å«ä¸­æ–‡ï¼ˆæœªç¿»è¯‘ï¼‰

**å¯èƒ½åŸå› **ï¼š
1. ä½¿ç”¨äº†æ¨ç†æ¨¡å‹ï¼ˆå¦‚ DeepSeek-R1ï¼‰çš„æ¨ç†å†…å®¹
2. æ¨¡å‹è¾“å‡ºåŒ…å« `reasoning_content`

**è§£å†³æ–¹æ³•**ï¼š
`OpenAIProvider` å·²ç»è‡ªåŠ¨å¤„ç†äº†æ¨ç†æ¨¡å‹ï¼Œä¼šä¸¢å¼ƒ `reasoning_content`ã€‚å¦‚æœæ˜¯è‡ªå®šä¹‰å®ç°ï¼Œéœ€è¦æ·»åŠ ï¼š

```python
if hasattr(message, 'reasoning_content') and message.reasoning_content:
    logger.warning("Discarding reasoning content")
    # åªè¿”å›å®é™…å†…å®¹ï¼Œä¸è¿”å›æ¨ç†è¿‡ç¨‹
    return message.content
```

### Q5: å¦‚ä½•æ·»åŠ æœ¬åœ° Providerï¼ˆå¦‚ Ollamaï¼‰

æœ¬åœ° Provider ä¸éœ€è¦ API Keyï¼Œéœ€è¦ä½¿ç”¨ `LocalProviderValidationMixin`ï¼š

```python
from providers.mixins import LocalProviderValidationMixin

class LocalProvider(BaseProvider, LocalProviderValidationMixin):
    def validate_configuration(self) -> tuple[bool, Optional[str]]:
        """æœ¬åœ° Providerï¼šæ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ"""
        # æ£€æŸ¥æœ¬åœ°æœåŠ¡ç«¯å£
        # ...
        return True, None
```

---

## æ€»ç»“

### å¿«é€Ÿå‚è€ƒå¡ç‰‡

| ä»»åŠ¡ | æ–‡ä»¶ | ä»£ç é‡ |
|------|------|--------|
| æ·»åŠ ç±»å‹æšä¸¾ | `src/core/types.py` | 1 è¡Œ |
| åˆ›å»º Provider ç±» | `src/providers/{name}/provider.py` | 20-50 è¡Œ |
| æ³¨å†Œ Provider | `src/providers/registry.py` | 3 å¤„ä¿®æ”¹ |
| ç¯å¢ƒé…ç½® | `.env` | 3-4 è¡Œ |
| å‰ç«¯ç±»å‹ | `frontend/src/types/api.ts` | 1 è¡Œ |
| å‰ç«¯ä¿¡æ¯ | `frontend/src/components/ProviderSelector/index.tsx` | 4 è¡Œ |

**æ€»è®¡**ï¼šå…¼å®¹ OpenAI API çš„æœåŠ¡å•†ï¼Œçº¦ **30-60 è¡Œä»£ç ** å³å¯å®Œæˆé›†æˆã€‚

### æœ€ä½³å®è·µ

1. **ä¼˜å…ˆç»§æ‰¿**ï¼šå¦‚æœæœåŠ¡å•†å…¼å®¹ OpenAI APIï¼Œç›´æ¥ç»§æ‰¿ `OpenAIProvider`
2. **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨ `ProviderType` æšä¸¾ï¼Œé¿å…å­—ç¬¦ä¸²ç¡¬ç¼–ç 
3. **é…ç½®åˆ†ç¦»**ï¼šæ‰€æœ‰é…ç½®é€šè¿‡ç¯å¢ƒå˜é‡ç®¡ç†ï¼Œä¸ç¡¬ç¼–ç 
4. **é”™è¯¯å¤„ç†**ï¼šå®ç° `validate_configuration` å’Œ `health_check`
5. **æ—¥å¿—è®°å½•**ï¼šä½¿ç”¨ `logger` è®°å½•å…³é”®æ“ä½œå’Œé”™è¯¯
6. **æµ‹è¯•è¦†ç›–**ï¼šç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

---

## é™„å½•

### A. å®Œæ•´æ–‡ä»¶æ¸…å•

æ·»åŠ æ–° Provider éœ€è¦ä¿®æ”¹/åˆ›å»ºçš„æ–‡ä»¶ï¼š

```
document-translation/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â””â”€â”€ types.py                          # âœï¸ ä¿®æ”¹ï¼šæ·»åŠ  ProviderType æšä¸¾
â”‚   â”œâ”€â”€ providers/
â”‚   â”‚   â”œâ”€â”€ {your_provider}/                  # âœ¨ æ–°å»ºï¼šProvider ç›®å½•
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py                   # âœ¨ æ–°å»º
â”‚   â”‚   â”‚   â””â”€â”€ provider.py                   # âœ¨ æ–°å»ºï¼šProvider å®ç°
â”‚   â”‚   â””â”€â”€ registry.py                       # âœï¸ ä¿®æ”¹ï¼šæ³¨å†Œ Provider
â”‚   â””â”€â”€ core/
â”‚       â””â”€â”€ config.py                         # âœï¸ ä¿®æ”¹ï¼šæ·»åŠ é…ç½®è¯»å–
â”œâ”€â”€ frontend/
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ types/
â”‚       â”‚   â””â”€â”€ api.ts                        # âœï¸ ä¿®æ”¹ï¼šæ›´æ–°ç±»å‹å®šä¹‰
â”‚       â””â”€â”€ components/
â”‚           â””â”€â”€ ProviderSelector/
â”‚               â””â”€â”€ index.tsx                 # âœï¸ ä¿®æ”¹ï¼šæ·»åŠ  Provider ä¿¡æ¯
â”œâ”€â”€ .env                                       # âœï¸ ä¿®æ”¹ï¼šæ·»åŠ ç¯å¢ƒå˜é‡
â””â”€â”€ docs/
    â””â”€â”€ ADD_NEW_PROVIDER_GUIDE.md             # ğŸ“– æœ¬æ–‡æ¡£
```

### B. ç›¸å…³æ–‡æ¡£

- [ç³»ç»Ÿæ¶æ„æŒ‡å—](ARCHITECTURE_GUIDE.md)
- [API è§„èŒƒæ–‡æ¡£](rest-api-specification.md)
- [Provider æ¥å£å®šä¹‰](../src/providers/base.py)

### C. è·å–å¸®åŠ©

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. æŸ¥çœ‹ç°æœ‰ Provider å®ç°ï¼ˆ`src/providers/`ï¼‰
2. é˜…è¯»æœ¬æ–‡æ¡£çš„[å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)éƒ¨åˆ†
3. æ£€æŸ¥æ—¥å¿—è¾“å‡ºï¼ˆåç«¯å’Œæµè§ˆå™¨æ§åˆ¶å°ï¼‰
4. è¿è¡Œæµ‹è¯•éªŒè¯é…ç½®

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0
**æœ€åæ›´æ–°**: 2025-01-19
**ç»´æŠ¤è€…**: Document Translation Team
