# 提示词管理系统指南

## 概述

提示词管理系统提供了一个集中管理所有翻译提示词的方式，通过外部文件使提示词可配置、模块化，并且无需修改 Python 代码即可维护。

## 架构

### 提示词文件结构
```
prompts/
└── translation/
    ├── base.md               # 核心翻译指令
    ├── glossary.md           # 术语表注入规则
    ├── markdown_rules.md     # Markdown 格式规则
    └── provider_system.md    # Provider 系统提示词模板
```

### 提示词管理组件

#### 1. PromptLoader (`src/prompt/loader.py`)
- 从文件系统加载提示词文件
- 处理 UTF-8 编码和错误情况
- 提供降级功能
- 支持提示词列表和验证

#### 2. PromptRenderer (`src/prompt/renderer.py`)
- 使用占位符替换渲染提示词模板
- 使用 `{{PLACEHOLDER}}` 语法表示占位符
- 支持条件包含和安全渲染
- 无代码执行 - 纯字符串替换

#### 3. PromptManager (`src/prompt/manager.py`)
- 结合加载和渲染的高级接口
- 为翻译工作流提供便捷方法
- 处理提示词组合和验证

## 使用示例

### 基础提示词加载
```python
from src.prompt import PromptManager

manager = PromptManager()

# 加载基础翻译提示词
base_prompt = manager.get_base_translation_prompt()

# 加载包含术语的术语表提示词
glossary_prompt = manager.get_glossary_prompt({
    "证书中心": "BytePlus Certificate Center"
})
```

### 提示词组合
```python
# 组合多个提示词
complete_prompt = manager.compose_prompt(
    'translation/base.md',
    'translation/glossary.md',
    GLOSSARY=terms_dict
)

# 构建包含术语表的完整翻译提示词
prompt = manager.build_complete_translation_prompt(
    glossary=terms_dict,
    use_provider_system=False
)
```

### 自定义模板渲染
```python
from src.prompt import PromptRenderer

renderer = PromptRenderer()

template = "翻译 {{LANGUAGE}} 文档，遵循 {{RULES}}"
result = renderer.render(template, LANGUAGE="中文", RULES="严格格式化")
# 结果: "翻译 中文 文档，遵循 严格格式化"
```

## 提示词文件格式

### 基础提示词
简单的 markdown 或文本文件：
```markdown
你是一个专业翻译。将下方 Markdown 文档中的所有中文文本翻译成英文。

重要要求：
1. 翻译每一个中文文本，包括：
   - 标题和段落
   - 表格内容和表头
   - 列表项
   - 图片 alt 文本
```

### 带占位符的模板
使用 `{{PLACEHOLDER_NAME}}` 语法：
```markdown
术语表：
{{GLOSSARY}}

如果术语表中的某个术语在文档中没有出现，请忽略它。
```

### 可用占位符
- `{{GLOSSARY}}`: 中英文术语字典
- `{{MARKDOWN_RULES}}`: Markdown 格式规则
- `{{GLOSSARY_CONSTRAINTS}}`: 术语约束指令
- `{{INPUT}}`: 输入文档内容（用于系统提示词）

## 与 TranslationAgent 的集成

TranslationAgent 自动使用提示词管理系统：

```python
from src.agents import TranslationAgent, TranslationInput

agent = TranslationAgent()
input_data = TranslationInput(
    source_markdown="# 中文标题\n内容",
    glossary={"证书中心": "BytePlus Certificate Center"}
)

# 自动使用 prompts/translation/base.md + prompts/translation/glossary.md
result = agent.translate(input_data)
```

## 自定义

### 添加新提示词
1. 在 `prompts/` 目录中创建新的 `.md` 或 `.txt` 文件
2. 根据需要使用占位符语法
3. 通过 PromptManager 访问：

```python
manager = PromptManager()
custom_prompt = manager.load_and_render('custom/my_prompt.md',
                                     CUSTOM_PLACEHOLDER=value)
```

### 修改现有提示词
只需编辑 `prompts/` 目录中的提示词文件：
- 更改立即生效
- 无需修改 Python 代码
- 所有代理自动使用更新后的提示词

### 添加新的占位符类型
扩展 PromptRenderer 以实现自定义格式化：

```python
renderer = PromptRenderer()
result = renderer.render(template,
                       my_custom_data=custom_object)
```

## 配置

### 基础目录
默认从项目根目录的 `prompts/` 目录加载提示词。可通过以下方式自定义：

```python
manager = PromptManager(base_dir="/custom/prompts/path")
```

### 严格模式
控制占位符验证行为：

```python
# 严格模式：对未定义的占位符抛出错误
manager = PromptManager(strict_mode=True)

# 非严格模式：未定义的占位符保持不变
manager = PromptManager(strict_mode=False)
```

## 错误处理

提示词系统提供了全面的错误处理：

- **文件未找到**：提供完整路径的清晰错误消息
- **编码问题**：自动 UTF-8 处理和降级
- **占位符验证**：可选的必需占位符验证
- **优雅降级**：文件缺失时回退到默认提示词

## 测试提示词

### 验证提示词结构
```python
manager = PromptManager()

# 检查提示词文件是否存在
exists = manager.prompt_exists('translation/base.md')

# 验证占位符
validation = manager.validate_prompt_structure(
    'translation/glossary.md',
    GLOSSARY={'test': 'value'}
)

# 获取提示词信息
info = manager.get_prompt_info('translation/base.md')
print(f"占位符: {info['placeholders']}")
```

### 列出可用提示词
```python
prompts = manager.list_available_prompts('translation')
for name, path in prompts.items():
    print(f"{name}: {path}")
```

## 最佳实践

### 1. 保持提示词专注
- 每个提示词文件应该有单一职责
- 使用组合而不是大型提示词
- 将规则与系统消息分离

### 2. 使用描述性占位符
- 使用 `{{GLOSSARY}}` 而不是 `{{G}}`
- 使用 `{{MARKDOWN_RULES}}` 而不是 `{{RULES}}`

### 3. 提供降级方案
```python
fallback_prompt = "默认翻译指令"
prompt = manager.load_and_render('custom.md', fallback=fallback_prompt)
```

### 4. 版本控制提示词
- 在版本控制中跟踪提示词更改
- 为提示词修改使用有意义的提交消息
- 考虑为生产系统的提示词进行版本控制

## 从硬编码提示词迁移

提示词系统在保持向后兼容的同时支持迁移：

1. **保留现有行为**：所有当前功能保持不变
2. **渐进式迁移**：可以逐步迁移提示词
3. **降级支持**：系统可以在需要时回退到硬编码提示词

### 迁移示例
```python
# 旧方式（硬编码）
prompt = self._get_translation_prompt()

# 新方式（外部文件）
prompt = self.prompt_manager.get_base_translation_prompt()
```

该系统使提示词管理成为一等公民，同时保持完全相同的翻译行为和性能特征。

## GlossaryFlow 特有功能

### 术语表驱动的提示词系统
GlossaryFlow 的核心优势在于术语表与提示词的深度集成：

```python
# 术语表自动注入到提示词
glossary_prompt = manager.get_glossary_prompt({
    "虚拟私有云": "Virtual Private Cloud",
    "负载均衡器": "Load Balancer"
})

# 提示词会强制 LLM 使用这些翻译
result = agent.translate(input_data)
```

### 可控的翻译流程
通过修改提示词，可以控制翻译行为：

```python
# 编辑 prompts/translation/base.md
# 添加更严格的规则：
# "必须严格遵守术语表中的翻译"
# "不允许创造新的术语翻译"
```

### 翻译质量保证
提示词系统确保：
- ✅ 术语翻译一致性
- ✅ 格式保持完整
- ✅ 翻译风格统一
- ✅ 可定制的翻译策略

## 相关资源

- [新增翻译服务商指南](新增翻译服务商指南.md) - 集成新的 LLM 服务
- [REST API 规范](RESTAPI规范.md) - API 接口文档
- [贡献指南](docs/CONTRIBUTING.md) - 如何参与贡献

---

**提示词管理**：让翻译效果可控、可定制、可优化。
